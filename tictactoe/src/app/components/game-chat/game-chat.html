<div class="fixed bottom-6 right-6 z-50 flex flex-col items-end gap-3">
  <!-- Botón flotante (FAB) cuando está colapsado -->
  <button
    *ngIf="!expanded"
    type="button"
    (click)="openPanel()"
    class="flex items-center justify-center w-14 h-14 rounded-full bg-blue-600 text-white shadow-lg hover:bg-blue-700 hover:scale-110 active:scale-95 transition-all duration-200"
    title="Abrir chat con {{ opponentUsername }}">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
  </button>

  <!-- Panel del chat que se despliega -->
  <div
    *ngIf="expanded"
    class="chat-panel-deploy flex flex-col bg-white rounded-2xl shadow-xl w-[min(100vw-2rem,380px)] max-h-[70vh] overflow-hidden border border-slate-100">
    <div class="flex items-center justify-between p-4 border-b border-slate-100 shrink-0">
      <h3 class="font-semibold text-slate-800 truncate pr-2">Chat con {{ opponentUsername }}</h3>
      <button
        type="button"
        (click)="expanded = false"
        class="p-2 rounded-lg text-slate-500 hover:bg-slate-100 transition-colors shrink-0"
        aria-label="Cerrar">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div
      id="game-chat-messages"
      class="flex-1 overflow-y-auto p-4 space-y-3 min-h-[200px] max-h-[300px] bg-slate-50/50">
      <p *ngIf="loading" class="text-sm text-slate-500">Cargando mensajes...</p>
      <p *ngIf="error" class="text-sm text-red-600">{{ error }}</p>
      <p *ngIf="!loading && !error && messages.length === 0" class="text-sm text-slate-500">Aún no hay mensajes.</p>
      <div
        *ngFor="let m of messages"
        class="flex"
        [class.justify-end]="m.isMine"
        [class.justify-start]="!m.isMine">
        <div
          class="max-w-[80%] rounded-xl px-3 py-2 text-sm"
          [class.bg-blue-500]="m.isMine"
          [class.text-white]="m.isMine"
          [class.ml-auto]="m.isMine"
          [class.bg-white]="!m.isMine"
          [class.text-slate-800]="!m.isMine"
          [class.border]="!m.isMine"
          [class.border-slate-200]="!m.isMine">
          <span *ngIf="!m.isMine" class="text-xs text-slate-500 block mb-0.5">{{ m.senderUsername }}</span>
          <span>{{ m.content }}</span>
          <span *ngIf="m.isMine && isMessageRead(m)" class="block mt-1 text-xs opacity-90">Leído</span>
        </div>
      </div>
    </div>

    <form (ngSubmit)="send()" class="p-4 border-t border-slate-100 flex gap-2 shrink-0">
      <input
        [(ngModel)]="newMessage"
        name="newMessage"
        type="text"
        placeholder="Escribe un mensaje..."
        class="flex-1 px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
        [disabled]="sending" />
      <button
        type="submit"
        [disabled]="!newMessage?.trim() || sending"
        class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
        Enviar
      </button>
    </form>
  </div>
</div>
